name: Update README with Thumbnails

on:
  schedule:
    - cron: '0 */4 * * *'     # প্রতি ৪ ঘণ্টায়
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate latest posts with images
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=20" -o feed.rss
          
          cat << 'EOF' > posts.md
          ## Latest 20 IPTV Playlists (Updated automatically)

          EOF

          python3 - << 'PY'
import xml.etree.ElementTree as ET, re, html
tree = ET.parse('feed.rss')
for item in tree.findall('./channel/item')[:20]:
    title = item.find('title').text
    link = item.find('link').text
    desc = item.find('.//{http://purl.org/rss/1.0/modules/content/}encoded').text or ""
    img = re.search(r'src=[](https://[1-4]\.bp\.blogspot\.com[^"]+\.jpg)', desc)
    thumb = img.group(1).replace('s72-c','s320').replace('s72-w','s320').replace('s72-h','s320') if img else "https://via.placeholder.com/480x270/0d1117/58a6e3ff?text=No+Image"
    print(f"[![{title}]({thumb})]({link})")
    print(f"**[{title}]({link})**  ")
    print("---")
PY

          cat posts.md >> README.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with 20 latest playlists + thumbnails" || exit 0
          git push
