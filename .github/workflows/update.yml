name: Update Playlists with Images

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate posts with images
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=20" > rss.xml

          CONTENT="## 20 Latest Playlists (Auto-updated every 4 hours)\n\n"
          while IFS= read -r line; do
            [[ $line =~ \<item\> ]] && { title=""; link=""; img=""; }
            [[ $line =~ \<title\>\<\!\[CDATA\[(.*)\]\]\>\<\/title\> ]] && title="${BASH_REMATCH[1]}"
            [[ $line =~ \<link\>(.*)\<\/link\> ]] && link="${BASH_REMATCH[1]}"
            [[ $line =~ src=\[](https://[0-9]+\.bp\.blogspot\.com[^\"]*\.jpg) ]] && img="${BASH_REMATCH[1]/s72-c/s400}"
            [[ $line =~ \<\/item\> ]] && [[ -n "$title" ]] && {
              thumb="${img:-https://via.placeholder.com/600x340/0d1117/58a6ff?text=No+Image}"
              CONTENT+="[![]($thumb)]($link)\n\n**[$title]($link)**\n\n---\n\n"
            }
          done < rss.xml

          # Replace everything between markers
          sed -i '/<!--PLAYLISTS_START-->/,/<!--PLAYLISTS_END-->/c\<!--PLAYLISTS_START-->\n'"$CONTENT"'<!--PLAYLISTS_END-->' README.md

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && echo "No changes" && exit 0
          git commit -m "Update 20 latest playlists with images"
          git push
