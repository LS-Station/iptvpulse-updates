name: Update Latest Playlists

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch RSS and update README with images
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=20" > feed.xml

          echo "## Latest 20 Playlists (with thumbnails)" > temp.md
          echo "" >> temp.md

          python3 -c "
import xml.etree.ElementTree as ET
tree = ET.parse('feed.xml')
root = tree.getroot()
items = root.findall('./channel/item')[:20]
for item in items:
    title = item.find('title').text
    link = item.find('link').text
    desc = item.find('{http://purl.org/rss/1.0/modules/content/}encoded').text
    import re
    img = re.search(r'src=\[](https://[1-4]\.bp\.blogspot\.com[^\"']+jpg)', desc)
    thumb = img.group(1).replace('s72-c', 's300') if img else 'https://via.placeholder.com/300x170/161b22/58a6ff?text=No+Image'
    print(f'[![{title}]({thumb})]({link})]({link})  ')
    print(f'**[{title}]({link})**  ')
    print('---')
" >> temp.md

          sed -i '/<!-- BLOG-POST-LIST:START -->/r temp.md' README.md

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with 20 latest playlists + thumbnails" || exit 0
          git push
